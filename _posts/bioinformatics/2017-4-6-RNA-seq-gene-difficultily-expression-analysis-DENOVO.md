---
layout: post
title: "RNA-seq 中的基因表达量计算和表达差异分析"
date: 2017-4-6
categories: bioninformatics
tag: RNA-seq
---

* content
{:toc}


#### 归一化

一、原因
1. 基因长度
2. 测序深度（建库大小）
3. 样本特异性
二、差异分析基于的假设
1. 不同样本基因总表达量相似
2. 上调差异表达与下调差异表达整体数量相似（上下调差异平衡）
3. 两组样本中不受处理效应影响的基因，表达量相似（差异不显著）。
4. 看家基因可作为表达量评价的依据（待定）

三、不同算法
1. 以什么数值来衡量表达量
RPKM、FPKM、TPM
2. 以什么作为参照标准
TMM（edgeR）、Deseq 矫正

RPKM：read
FPKM：fragment
TMP：transcript

问题：mRNA 总量未必相等
1. mRNA 总量不等-细胞本身不同
2. mRNA 总量不等-污染

解决方法-不同算法方法
不同的归一化算法（参照系）：
1. Total Count（TC）：总 reads 数矫正
2. Upper Quartile（UQ）
3. Median（Med）：
4. Quantile（Q）：基因芯片软件 limma 算法
5. RPKM：总 reads 数，引入了基因长度
6. 中位数：Deseq 算法
7. TMM：edgeR 算法

Deseq：
1. 理论上更加稳定
2. 不同批次的比较会得到不同的表达量值，不利于进行多处理组/批次数据的统一分析（如，趋势分析、共表达分析）
3. 校正会掩盖一些问题（如，样本污染）

RPKM算法：
1. 易受异常高表达基因、外源污染等干扰
2. 也容易发现问题
3. 得到的表达量值恒定，多处理组/批次的数据可以合并分析

折中方法：RPKM 类算法，但要人工检查数据是否异常
Deseq 也可以关闭校正功能

1. 实际经验，RPKM 比较稳定，但是要排除异常值（高表达基因、外源污染）
2. 细胞本身不同（如对照组实验组来自不同的组织或器官），可以用二次矫正（如，RT-PCR 定量内参基因（看家基因等），用内参基因二次矫正）。

-----
个人见解：
RPKM/FPKM：对基因长度和测序深度做了归一化
TPM：对基因长度和细胞的 mRNA 含量做了归一化
所以，
1. 当测序深度一致、细胞 mRNA 含量相似时，两种方法都可以
2. 当样本的测序深度不同时建议用 FPKM
3. 当样本的 mRNA 含量差异很大（对照组与实验组来自不同的器官、组织），建议用 TPM；若用 RPKM，再用内参基因（RT-PCR 管家基因）二次矫正，似乎也可选。
3. 当样本的测序深度和 mRNA 含量都不同时，建议放弃实验吧
-----

#### 差异分析算法及比较

一、基础理解：处理效应与误差效应
组内差异：误差效应
组间差异：误差效应+处理效应
处理平均方差 = 处理组间个体间的平均差异程度
训闫平均方差 = 处理内个体间的平均差异程度
检验的本质：处理效应 = 组间平均差异 - 组内平均差异 > 0
通常情况下，如果没有重复，组内差异则无法计算。

差异显著性：通过组内差异和组间差异的比较，是否显著

二、基础延伸：二项分布、泊松分布

三、基础假设
Read 在基因组上的分布：泊松分布。即，如果两组样本（没有重复），那么期望的测序深度（表达量均值）和（误差方差 = np）都可以估算出来。

基因差异表达分析判断的过程：
1. 组内和组间差异的估算
组间差异：处理组之间的差异；
组内（误差）差异：即测序的随机误差，利用泊松分布公式计算出来，不依赖于重复样本。
2. 组间差异是否大于误差差异；

RNA-seq 没有重复，依然可以进行差异检验的原因：利用公式预估测序随机误差的大小。

#### 差异分析的方法以及比较

一、实际生物学实验

- 误差效应：技术误差 + 生物学差异
- 组间差异：生理效应 + 误差效应

二、混合分布

技术误差：泊松分布
生物差异：伽马分布
生物学重复样本间的误差分布则符合：泊松分布 + 伽马分布 = 负二项分布
ν = μ + αμ^2
ν：方差；μ，均值；α，散度因子

edgeR 和 Deseq 都使用负二项分布，但对散度因子的估算方式不相同，所以最后的 P 值不同。

Read count 带来的误差
计算多重比对的 read要，在重新分配这类 reads 过程中，会引入误差，则：
- 生物学生物误差分布 = 负二项分布
- 多重比较对 reads 分配误差 = β 分布

生物学重复的转录本 reads 估计 = β 分布 + 负二项分布 = β 负二项分布（新版本 cuffdiff（v2）使用该假设）

小结和比较--三种分布
- 不同的差异分析方法的本质区别：对随机误差的估算方法
- 最早的流程：使用泊松分布，只考虑技术重复的误差（因此可以不测重复）。
- 后续开发的软件（Deseq、edgeR），使用负二项分布（泊松分布 + γ 分布），考虑技术重复误差和生物个体差异；
- 再后来开发的软件（cuffdiff），使用 β 负二项分布（泊松分布 + γ 分布 + β 分布），考虑对多重比对 reads 估算过程中的误差。

误差方差估算值：泊松分布 < 负二项分布 < β 负二项分布
显著性：泊松分布 > 负二项分布 > β 负二项分布

Deseq 软件方差估计的方法

1. 为什么使用 reads counts 作为输入
误差 = 测序误差（泊松分布） + 生物学差异（γ 分布）
生物差异相对固定。技术差异只与期望测序深度有关。所以每个基因的估算值不同。而且这个数值只能使用 reads 数来估算。
被测到的概率：期望测到的 reads 数（均值）/总 reads 数

所以，差异分析松有需要心 reads 数为输入，计算测序导致的随机误差，而不是 RPKM 值。使用 RPKM 对低丰度基因的估算不准确。

2. 使用 reads counts 作为输入
误差 = 技术误差（泊松分布） + 生物学差异（γ 分布）

表达量高的基因，生物学差异为主。
表达量低的基因，技术差异为主（reads count要数太低，导致定量不稳定），相对变异更大。所以，低表达的基因通常差异不显著。

3. 误差拟合

dispersion（离散系数），相当于标准差。在重复样本数很少时（2——3 个），单个基因的标准差估算误差很大，所以通过拟合，计算在特定表达量水平的基因的标准差均值。

四、不同方法在实际情况的应用

1. 组内差异过大为什么则找不到差异基因？
组内差异大，组间误差和组内误差比不显著，即得出组间没有差异

在此情况下，只能更加宽松的方法
1）换用统计方法
例如泊松分布，但实际上假阳性会提高，并没有改变误差组成，自欺欺人。
2）改变阈值
降低阈值（PDR 值 < 0.025）
3）剔除离群样本（如果重复数 ≧ 3）
4）别太信 p value（在没有生物学重复时，p 值可能不够小，可以适当降低阈值）
5）组内差异太大，可以考混样。

2. 方差分析中，低丰度基因的 P 值被低估，生出差异的结论不可靠。

3. 1）要想得到更多差异基因：
老流程（泊松分布）> deseq、edgeR（负二项分布）> cuffdiff（β 负二项分布）

2）cuffdiff 可以良好的控制假阳性，但也会带来大量假阴性，而且这个软件也有 bug。
3）旧的泊松分布流程，FDR 一般使用 0.1%，而新的流程，一般使用 1%。

------
P value 本身受使用的数学模型以及样本的数量影响非常大。
现在转录组的数据都要求生物学重复，无生物物学重复，一般使用 R 包 DEGseq 和 edgeR 的泊松分布，好像 cuffdiff 的 `--dispersion-method blind` 方法也可以用于无重复数据，但是当样本差异表达基因很多时，这种建模方式可能找不到显著的基因。
